---
import '../../styles/global.css';
// @ts-ignore - package exports named AstroSeo but types may not resolve correctly in some setups
import { AstroSeo } from '@astrolib/seo';
import { userConfig } from '../../config/index';

// Build base URL for API calls
const baseUrl = import.meta.env.PUBLIC_SITE_URL || Astro.url.origin;

// Fetch SEO config from API with fallback to site.ts
let seoTitle = userConfig.seo.title;
let seoDescription = userConfig.seo.description;
let seoKeywords = userConfig.seo.keywords;

try {
  const apiUrl = `${baseUrl}/api/content/config`;
  const response = await fetch(apiUrl);
  if (response.ok) {
    const config = await response.json();
    if (config.seo) {
      if (config.seo.title) seoTitle = config.seo.title;
      if (config.seo.description) seoDescription = config.seo.description;
      if (config.seo.keywords && Array.isArray(config.seo.keywords)) {
        seoKeywords = config.seo.keywords;
      }
    }
  }
} catch (error) {
  console.warn('[BaseHead] Failed to fetch SEO config from API, using fallback');
}

// Fetch backgrounds from API for OG image
let ogImageUrl: string | undefined = undefined;

try {
  const apiUrl = `${baseUrl}/api/content/backgrounds`;
  const response = await fetch(apiUrl);
  if (response.ok) {
    const backgrounds = await response.json();
    if (backgrounds.length > 0 && backgrounds[0].url) {
      ogImageUrl = backgrounds[0].url;
    }
  }
} catch (error) {
  console.warn('[BaseHead] Failed to fetch backgrounds from API for OG image');
}

// Build safe defaults for SEO
const siteOrigin = Astro.site ? new URL('/', Astro.site).origin : undefined;
const canonicalUrl = Astro.props.canonical || siteOrigin;
const ogUrl = Astro.props.openGraph?.url || siteOrigin;
---

<!-- Core meta tags -->
<meta charset='UTF-8' />
<meta http-equiv='X-UA-Compatible' content='IE=edge' />
<meta
  name='viewport'
  content='width=device-width, initial-scale=1, maximum-scale=1'
/>
<meta name='author' content="" />

<!-- SEO Configuration -->
<AstroSeo
  title={Astro.props.title || seoTitle}
  description={Astro.props.description || seoDescription}
  canonical={canonicalUrl}
  openGraph={{
    url: ogUrl,
    title: Astro.props.openGraph?.title || seoTitle,
    description: Astro.props.openGraph?.description || seoDescription,
    ...(ogImageUrl ? { images: [{ url: ogImageUrl }] } : {}),
    site_name: Astro.props.openGraph?.site_name || "",
  }}
  twitter={{
    cardType: 'summary_large_image',
  }}
/>
{seoKeywords.length > 0 && (
  <meta name="keywords" content={seoKeywords.join(', ')} />
)}

<!-- JSON-LD Schema.org -->
{siteOrigin && (
  <script type="application/ld+json">
    {JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'WebSite',
      url: siteOrigin,
      name: "",
      description: seoDescription,
    })}
  </script>
)}

<!-- Add your favicon files in public/images/ -->
<link rel='apple-touch-icon' sizes='180x180' href='https://avatars.githubusercontent.com/u/97130221?s=400&u=aaa4eb0bf9d07b901f0b15df8540fefea2fca729&v=4' />
<link
  rel='icon'
  type='image/png'
  sizes='32x32'
  href='https://avatars.githubusercontent.com/u/97130221?s=400&u=aaa4eb0bf9d07b901f0b15df8540fefea2fca729&v=4'
/>
<link
  rel='icon'
  type='image/png'
  sizes='16x16'
  href='https://avatars.githubusercontent.com/u/97130221?s=400&u=aaa4eb0bf9d07b901f0b15df8540fefea2fca729&v=4'
/>

<!-- Auto-generated sitemap -->
<link rel='sitemap' href='/sitemap-index.xml' />

<!-- Preload background images for performance -->
{ogImageUrl && (
  <link
    rel='preload'
    href={ogImageUrl}
    as='image'
    fetchpriority='high'
  />
)}
